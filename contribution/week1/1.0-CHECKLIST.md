# Week 1: Code Completion & Testing - Checklist

> Complete working implementation with comprehensive tests

**Goal:** By end of Week 1, you'll have a fully functional bidirectional trust pattern with 100% test coverage and 10+ testnet transactions as proof.

**Time Budget:** 20 hours (4 hours/day × 5 days)
**Status:** Not started

---

## Pre-Week Setup

- [ ] Run verification script: `python scripts/verify_bidirectional_state.py`
- [ ] Review verification report
- [ ] Read current ReputationRegistry.sol code
- [ ] Read current base_agent.py code
- [ ] Understand what exists vs. what needs to be built

**Estimated Time:** 2 hours
**Output:** Clear understanding of starting point

---

## Day 1: Implement Bidirectional Pattern in Smart Contract (4 hours)

### Morning: Review & Plan (1 hour)
- [ ] Read EIP-8004 ReputationRegistry spec
- [ ] Read your erc-8004-example/bidirectional implementation
- [ ] Identify what needs to be added to production contracts
- [ ] Sketch metadata tag schema

### Implementation: Update ReputationRegistry.sol (3 hours)
- [ ] Add `rateClient()` function if not present
- [ ] Add `rateValidator()` function if not present
- [ ] Define standardized metadata tags:
  - `client-rating` tag
  - `validator-rating` tag
  - `bidirectional` tag
- [ ] Add events: `ClientRated`, `ValidatorRated`
- [ ] Update giveFeedback() to handle new tags

**Files to modify:**
- `erc-8004/contracts/src/ReputationRegistry.sol`

**Acceptance Criteria:**
- [ ] Contract compiles: `forge build`
- [ ] Functions follow same pattern as existing `giveFeedback()`
- [ ] Events emitted for all rating types
- [ ] Code has inline comments

**Output:** Updated contract ready for testing

---

## Day 2: Smart Contract Tests (4 hours)

### Unit Tests: ReputationRegistry (3 hours)
- [ ] Test `rateClient()` - happy path
- [ ] Test `rateValidator()` - happy path
- [ ] Test metadata tag parsing
- [ ] Test edge cases:
  - [ ] Duplicate ratings
  - [ ] Invalid agent IDs
  - [ ] Missing authorization
  - [ ] Zero ratings
- [ ] Test events are emitted correctly

**Files to create:**
- `erc-8004/contracts/test/ReputationRegistry.t.sol` (or add to existing)

**Commands:**
```bash
cd erc-8004/contracts
forge test -vv
forge test --match-test testBidirectionalRating -vvv
```

### Gas Analysis (1 hour)
- [ ] Run gas report: `forge test --gas-report`
- [ ] Document gas costs for each function
- [ ] Compare to baseline `giveFeedback()` costs

**Acceptance Criteria:**
- [ ] All tests pass
- [ ] Test coverage >95%
- [ ] Gas costs documented

**Output:** `contribution/week1/1.2-test-results.md`

---

## Day 3: Python Integration in base_agent.py (4 hours)

### Morning: Plan Integration (1 hour)
- [ ] Read current base_agent.py implementation
- [ ] Identify where to add bidirectional rating methods
- [ ] Plan function signatures

### Implementation: Add Bidirectional Methods (3 hours)
- [ ] Add `rate_client(client_id, rating, comment)` method
- [ ] Add `rate_validator(validator_id, rating, comment)` method
- [ ] Add `get_bidirectional_ratings(agent_id)` method
- [ ] Add helper: `_create_feedback_metadata(tags)`
- [ ] Update `give_feedback()` to support new tags

**Files to modify:**
- `shared/base_agent.py`

**Example code structure:**
```python
def rate_client(self, client_id: int, rating: int, comment: str = ""):
    """Rate a client after completing a transaction."""
    tags = ["client-rating", "bidirectional"]
    feedback_uri = self._create_feedback_uri(comment)
    feedback_auth = self._sign_feedback_auth(...)

    tx = self.reputation_registry.functions.giveFeedback(
        client_id, rating, tags, feedback_uri, feedback_auth
    ).transact({'from': self.agent_address})

    return tx
```

**Acceptance Criteria:**
- [ ] Methods follow existing base_agent patterns
- [ ] Proper error handling
- [ ] Type hints for all parameters
- [ ] Docstrings for all methods

**Output:** Updated base_agent.py

---

## Day 4: Integration Tests (4 hours)

### Python Integration Tests (3 hours)
- [ ] Test complete transaction flow:
  1. Client purchases from Seller
  2. Seller rates Client
  3. Retrieve Client's rating
- [ ] Test validator flow:
  1. Validator validates data
  2. Seller rates Validator
  3. Retrieve Validator's rating
- [ ] Test rating history retrieval
- [ ] Test error handling

**Files to create:**
- `tests/test_bidirectional_transactions.py`

**Test structure:**
```python
def test_seller_rates_client():
    # Setup: Register agents
    seller = ERC8004BaseAgent(config_seller)
    client = ERC8004BaseAgent(config_client)

    # Action: Seller rates client after transaction
    tx = seller.rate_client(client.agent_id, rating=90, comment="Great client")

    # Assert: Rating recorded on-chain
    ratings = seller.get_bidirectional_ratings(client.agent_id)
    assert ratings['client-rating'] == 90
```

### Run Tests (1 hour)
```bash
pytest tests/test_bidirectional_transactions.py -v
pytest tests/test_bidirectional_transactions.py::test_seller_rates_client -vv
```

**Acceptance Criteria:**
- [ ] All integration tests pass
- [ ] Tests cover both success and failure scenarios
- [ ] Test output is clear and descriptive

**Output:** `contribution/week1/1.3-integration-test-results.md`

---

## Day 5: End-to-End Testnet Validation (4 hours)

### Deploy to Fuji Testnet (1 hour)
- [ ] Update .env with Fuji RPC URL
- [ ] Deploy updated ReputationRegistry contract
- [ ] Update .env.deployed with new contract address
- [ ] Verify deployment on Snowtrace

**Commands:**
```bash
cd erc-8004
./deploy-fuji.sh  # or deploy-fuji.ps1
```

### Execute Real Transactions (2 hours)
- [ ] Transaction 1: karma-hello rates client-agent
- [ ] Transaction 2: skill-extractor rates client-agent
- [ ] Transaction 3: karma-hello rates validator
- [ ] Transaction 4: abracadabra rates validator
- [ ] Transaction 5: skill-extractor rates abracadabra (client)
- [ ] Transactions 6-10: More diverse rating scenarios

**Script to create:**
- `scripts/execute_bidirectional_testnet_transactions.py`

**Script should:**
1. Load all agent configs
2. Execute 10 bidirectional rating transactions
3. Log transaction hashes
4. Verify on-chain with Snowtrace links
5. Export results to CSV

### Verify On-Chain (1 hour)
- [ ] Check each transaction on Snowtrace
- [ ] Verify events were emitted
- [ ] Screenshot key transactions
- [ ] Document transaction hashes

**Acceptance Criteria:**
- [ ] 10+ transactions successfully executed
- [ ] All visible on Snowtrace
- [ ] Transaction hashes documented
- [ ] CSV export of all transactions

**Outputs:**
- `contribution/week1/1.4-testnet-transactions.csv`
- `contribution/week1/1.4-testnet-transaction-hashes.txt`
- `contribution/week1/1.4-testnet-screenshots/`

---

## Week 1 Deliverables Checklist

### Code
- [ ] Updated ReputationRegistry.sol
- [ ] Updated base_agent.py
- [ ] All code committed and pushed

### Tests
- [ ] Smart contract unit tests (forge)
- [ ] Python integration tests (pytest)
- [ ] All tests passing
- [ ] Test coverage report

### Testnet Validation
- [ ] 10+ transactions executed on Fuji
- [ ] Transaction hashes documented
- [ ] CSV export of transaction data
- [ ] Screenshots of key transactions on Snowtrace

### Documentation
- [ ] Week 1 summary: `contribution/week1/1.5-WEEK-SUMMARY.md`
- [ ] Test results documented
- [ ] Gas cost analysis
- [ ] Lessons learned

### Progress Tracking
- [ ] Updated `contribution/0.2-PROGRESS-TRACKER.md`
- [ ] Week 1 retrospective completed
- [ ] Ready to start Week 2

---

## Success Criteria for Week 1

**You're ready for Week 2 when:**
1. ✅ All tests pass (unit + integration)
2. ✅ 10+ testnet transactions executed successfully
3. ✅ Transaction data exported and documented
4. ✅ Week 1 summary written
5. ✅ Code committed with clear messages
6. ✅ Progress tracker updated

**If any criteria not met:** Don't proceed to Week 2. Fix issues first.

---

## Troubleshooting

**Contract won't compile:**
- Check Solidity version matches existing contracts
- Verify import paths
- Run `forge clean && forge build`

**Tests failing:**
- Check contract addresses in .env
- Verify agents are registered
- Check AVAX balance for gas
- Use `-vvv` flag for detailed errors

**Transactions reverting:**
- Check agent has AVAX for gas
- Verify agent is registered
- Check feedback authorization signature
- View revert reason on Snowtrace

**Need help?**
- Review erc-8004-example/bidirectional code
- Check EIP-8004 spec
- Ask in Ethereum forums

---

**Next:** After completing Week 1, move to `contribution/week2/2.0-CHECKLIST.md`
