%% Sybil Attack Detection Flowchart
%% Multi-signal approach: Graph Clustering + Temporal + Statistical + Transaction Validation

flowchart TD
    START([New Agent Registers<br/>or Submits Rating]) --> COLLECT[Collect Signals<br/>from All Agents]

    COLLECT --> GRAPH{Graph Clustering<br/>Analysis}
    COLLECT --> TEMPORAL{Temporal<br/>Analysis}
    COLLECT --> STATS{Statistical<br/>Outlier Detection}
    COLLECT --> TX{Transaction<br/>Validation}

    %% Graph Clustering Branch
    GRAPH -->|High clustering coefficient<br/>>0.8| GRAPH_CHECK[Check External Edges]
    GRAPH_CHECK -->|<20% external connections| GRAPH_FLAG[ðŸš¨ Flag: Sybil Cluster<br/>Confidence: 95%]
    GRAPH_CHECK -->|>20% external| GRAPH_OK[âœ… Pass: Legitimate Network]

    %% Temporal Analysis Branch
    TEMPORAL -->|Rating burst detected<br/>>10 ratings in 1 hour| TEMP_CHECK[Check Account Age]
    TEMP_CHECK -->|Account <24h old| TEMP_FLAG[ðŸš¨ Flag: Suspicious Timing<br/>Confidence: 80%]
    TEMP_CHECK -->|Account >24h old| TEMP_OK[âœ… Pass: Normal Activity]

    %% Statistical Outlier Branch
    STATS -->|All ratings 95-100<br/>No variance| STATS_CHECK[Check Rating Distribution]
    STATS_CHECK -->|Stddev <5| STATS_FLAG[ðŸš¨ Flag: Artificial Ratings<br/>Confidence: 75%]
    STATS_CHECK -->|Stddev >5| STATS_OK[âœ… Pass: Natural Distribution]

    %% Transaction Validation Branch
    TX -->|No real payment confirmed| TX_CHECK[Check On-Chain Evidence]
    TX_CHECK -->|0 confirmed transactions| TX_FLAG[ðŸš¨ Flag: Fake Transactions<br/>Confidence: 100%]
    TX_CHECK -->|>0 confirmed| TX_OK[âœ… Pass: Real Transactions]

    %% Aggregation
    GRAPH_FLAG --> AGGREGATE{Aggregate Signals<br/>Multi-Signal Detection}
    TEMP_FLAG --> AGGREGATE
    STATS_FLAG --> AGGREGATE
    TX_FLAG --> AGGREGATE

    GRAPH_OK --> AGGREGATE
    TEMP_OK --> AGGREGATE
    STATS_OK --> AGGREGATE
    TX_OK --> AGGREGATE

    %% Decision
    AGGREGATE -->|2+ flags triggered| FINAL_SYBIL[ðŸš« SYBIL DETECTED<br/>Block from marketplace<br/>Notify other agents]
    AGGREGATE -->|0-1 flags| FINAL_OK[âœ… LEGITIMATE AGENT<br/>Allow transactions]

    FINAL_SYBIL --> REPORT[Report to Community<br/>â€¢ Agent ID<br/>â€¢ Confidence score<br/>â€¢ Detected signals<br/>â€¢ On-chain evidence]

    FINAL_OK --> END([Agent Participates<br/>Normally])

    %% Styling
    classDef flagNode fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef okNode fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef checkNode fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef decisionNode fill:#e1f5ff,stroke:#01579b,stroke-width:2px

    class GRAPH_FLAG,TEMP_FLAG,STATS_FLAG,TX_FLAG,FINAL_SYBIL flagNode
    class GRAPH_OK,TEMP_OK,STATS_OK,TX_OK,FINAL_OK okNode
    class GRAPH_CHECK,TEMP_CHECK,STATS_CHECK,TX_CHECK checkNode
    class GRAPH,TEMPORAL,STATS,TX,AGGREGATE decisionNode

    %% Notes
    note1[Detection Accuracy:<br/>â€¢ Graph: 95%<br/>â€¢ Temporal: 80%<br/>â€¢ Statistical: 75%<br/>â€¢ Transaction: 100%<br/>â€¢ Combined: 91%]
    note2[Cost to Attack:<br/>â€¢ 10 fake agents: $13<br/>â€¢ Detection: 95%<br/>â€¢ Expected value: -$2.35<br/>â†’ Economically irrational]

    AGGREGATE -.-> note1
    FINAL_SYBIL -.-> note2
